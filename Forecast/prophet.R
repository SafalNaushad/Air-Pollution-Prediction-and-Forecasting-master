library(ggplot2)
library(prophet)
library(tidyverse)
library(tidyquant)
library(cowplot)
library(MLmetrics)


#read and remove columns from file 
chennai <- read_csv("c1_cat.csv")
delhi <- read_csv("d1_cat.csv")
hydrabad <- read_csv("h1_cat.csv")
kolkata <- read_csv("k1_cat.csv")
mumbai <- read_csv("m1_cat.csv")


# select one
c1 <- read_csv("org_ch.csv")
c1 <- read_csv("org_dh.csv")
c1 <- read_csv("org_ko.csv")
c1 <- read_csv("org_hy.csv")
c1 <- read_csv("org_mu.csv")


str(c1)


# Visualization of data
qplot(dates, AQI, data = c1)


#store date to ds and log of AQi to y
ds <- c1$dates
y <- c1$AQI


# Create a datframe with it
df <- data.frame(ds, y)


#plot log data to see more seasonality
qplot(ds, y, data = df)


#advanced Visualization
p1 <- c1 %>%
  ggplot(aes(dates, AQI)) +
  geom_point(color = palette_light()[[1]], alpha = 0.5) +
  theme_tq() +
  labs(
    title = "From 2016 to 2020 (Full Data Set)"
  )
p2 <- df %>%
  ggplot(aes(ds, y)) +
  geom_line(color = palette_light()[[1]], alpha = 0.5) +
  geom_point(color = palette_light()[[1]]) +
  geom_smooth(method = "loess", span = 0.2, se = FALSE) +
  theme_tq() +
  labs(
    title = "With log",
    caption = "datasets::AirQuality.AQI"
  )
p_title <- ggdraw() + 
  draw_label("AQI", size = 18, fontface = "bold", colour = palette_light()[[1]])

plot_grid(p_title, p1, p2, ncol = 1, rel_heights = c(0.1, 1, 1))


#create model m using prophet fuction
m <- prophet(df)


#create forecasting variable
future <- make_future_dataframe(m, periods = 7)


#analysing the variable
tail(future)


#Forecasting
forecast <- predict(m, future)


#Summary Model
tail(forecast[c('ds', 'yhat', 'yhat_lower', 'yhat_upper')])


#Check result
exp(4.058228)


#plot forecasting
plot(m, forecast)


#check seasonality and components
prophet_plot_components(m, forecast)


# calculate accuracy(0.4495045)
RMSE(forecast$yhat, y)
